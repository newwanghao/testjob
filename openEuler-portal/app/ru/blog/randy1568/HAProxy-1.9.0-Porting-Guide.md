---
title: Руководство по портированию HAProxy 1.9.0 (openEuler 20.03 LTS SP1)  
category: blog 
date: 2021-12-29  
tags:  
    - HAProxy  
    - Руководство по портированию  
sig: sig-Compatibility-Infra  
archives: 2021-12  
author: randy1568  
summary: Принципы портирования HAProxy 1.9.0
---

# Руководство по портированию HAProxy 1.9.0 (openEuler 20.03 LTS SP1)

## Введение

#### Обзор

HAProxy — это свободное программное обеспечение с открытым исходным кодом, написанное на языке C. Выполняя роль балансировщика нагрузки высокой доступности и прокси-сервера для приложений TCP и HTTP, программа поддерживает виртуальные хосты, отличается быстродействием и надежностью. 

Язык программирования: C

Краткое описание: веб-балансировщик нагрузки

#### Рекомендуемая версия программного обеспечения

HAProxy 1.9.0

Примечание.

Данный документ адресован версии HAProxy 1.9.0. Также этот документ можно использовать для справки при портировании других версий HAProxy.

## Требования к среде

#### Аппаратное обеспечение

| Параметр              | Описание                         |
| --------------------- | -------------------------------- |
| Сервер                | Сервер TaiShan 200 (модель 2280) |
| Центральный процессор | Процессор Kunpeng 920 5250       |
| Раздел диска          | Нет требований                   |

#### Операционная система

| Параметр  | Версия                |
| --------- | --------------------- |
| openEuler | 20.03 LTS SP1 AArch64 |
| Ядро      | 4.19                  |

Проверьте актуальную информацию о системе.

```bash
cat /etc/os-release
```

<img src="./image/HAProxy-1.jpeg">  

Подробную информацию об установке ОС openEuler см. в документе https://docs.openeuler.org/en/docs/20.03\_LTS\_SP1/docs/Installation/Installation.html.  

Примечание.

Рекомендуется выбрать режим установки «Server with GUI».

## Установка HAProxy с использованием пакета RPM, полученного с зеркального узла

Если с сервера есть доступ к сети, загрузите пакет RPM, выполнив команду «wget https://mirrors.huaweicloud.com/kunpeng/yum/el/7/aarch64/Packages/web/haproxy-1.9.0-1.el7.aarch64.rpm». Если доступа нет, перейдите на страницу https://mirrors.huaweicloud.com/kunpeng/yum/el/7/aarch64/Packages/web/haproxy-1.9.0-1.el7.aarch64.rpm, загрузите пакет и скопируйте его в каталог **/home** на сервере.

Примечание.

Пакеты RPM с зеркального узла компилируются и собираются с помощью открытого исходного кода и затем выгружаются на этот зеркальный узел.

Далее описана процедура загрузки пакета RPM на локальный ПК с последующей выгрузкой его на сервер.

1. Установите HAProxy.
   
   ```bash
   rpm -ivh haproxy-1.9.0-1.el7.aarch64.rpm
   ```
   
   <img src="./image/HAProxy-2.png">

2. Просмотрите инсталляционный каталог.
   
   ```bash
   ls /usr/local/haproxy
   ```
   
   <img src="./image/HAProxy-3.png">


## Выполнение операций и верификация

- Сконфигурируйте параметры.
  
  a. Откройте файл **option-http\_proxy.cfg**.
  
  ```bash
  vi  /usr/local/haproxy/conf/option-http_proxy.cfg
  ```
  
  b. Измените файл, как приведено далее, сохраните изменения и закройте файл:
  
  ```bash
  global
  maxconn      20000
  log               127.0.0.1 local0  info
  uid               0
  gid               0
  chroot          /usr/local/haproxy
  nbproc          4
  daemon
  defaults
  mode                       http
  retries                      3
  timeout connect      10s
  timeout client          20s
  timeout server         30s
  timeout check          2s
  frontend test-proxy
  bind            *:80
  mode            http
  log             global
  default_backend test-proxy-srv
  backend test-proxy-srv
  balance        roundrobin
  option http-server-close
  option httpchk   GET /index.html
  http-check expect       status 200
  server          web1    IP1:PORT1 weight 3
  server          web2    IP2:PORT2 weight 3
  ```
  
  Подробную информацию о параметрах, содержащихся в конфигурационном файле, см. в [следующей таблице](https://support.huaweicloud.com/prtg-kunpengwebs/kunpenghaproxy_02_0011.html#kunpenghaproxy_02_0011__table177828478439).

| Параметр                                                     | Описание                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| global                                                       | \-                                                           |
| maxconn 20000                                                | Максимальное количество соединений.                          |
| log 127.0.0.1 local0 info                                    | Параметр задает устройство вывода журнала. Информация содержит уровень серьезности журнала. |
| uid 0                                                        | Идентификатор пользователя, запускающего в работу HAProxy.   |
| gid 0                                                        | Идентификатор группы, в которую входит пользователь, запускающий в работу HAProxy. |
| chroot /usr/local/haproxy                                    | Путь запуска chroot.                                         |
| nbproc 4                                                     | Количество процессов.                                        |
| daemon                                                       | Параметр запускает выполнение HAProxy в фоновом режиме.      |
| defaults                                                     | \-                                                           |
| mode http                                                    | Тип обработки (на уровне 7 используется HTTP, на уровне 4 — TCP). |
| retries 3                                                    | Максимальное количество попыток подключения к backend-серверу. В случае превышения заданного значения, то есть после исчерпания всех попыток, backend-сервер будет недоступен. |
| timeout connect 10s                                          | Максимальное время ожидания установления соединения между HAProxy и backend-сервером. |
| timeout client 20s                                           | Время удержания соединения с клиентом на ожидании.           |
| timeout server 30s                                           | Время удержания соединения с сервером на ожидании.           |
| timeout check 2s                                             | Время ожидания проверки сервера.                             |
| frontend test-proxy                                          | \-                                                           |
| bind \*:80                                                   | Данным параметром задается один или более прослушивающих сокетов. Значком звездочки (\*) задаются все IPv4-адреса. |
| mode http                                                    | Тип обработки (на уровне 7 используется HTTP, на уровне 4 — TCP). |
| log global                                                   | Параметр устанавливает наследование определения журнала в глобальном разделе. |
| default\_backend test-proxy-srv                              | Параметр задает пул backend-сервера, используемый по умолчанию. |
| backend test-proxy-srv                                       | \-                                                           |
| balance roundrobin                                           | Параметр устанавливает циклический алгоритм балансировки нагрузки, который представляет собой алгоритм взвешенного опроса и применяется в сценариях, в которых серверы обладают примерно одинаковой производительностью. |
| option http-server-                                          | Данный параметр необходимо включить в условиях включенного постоянного соединения. |
| option httpchk GET /index.htmlhttp-check expect status 200   | Параметр включает проверку статуса службы HTTP (проверка работоспособности), в процессе которой проверяется возвращаемый код со статусом. Если код «200» не возвращается, запросы на backend-серверы не отправляются. |
| server web1IP1:PORT1 weight 3 server web2 IP2:PORT2 weight 3 | Параметр определяет несколько backend-серверов. Формат: server  :\[port] \[param\*]\*\* (Примечание: \*\*IP1:PORT1 и IP2:PORT2 — это IP-адреса и номера портов backend-серверов.) |

- Запустите HAProxy.
  
  ```bash
  taskset -c 0-3 /usr/local/haproxy/sbin/haproxy -f /usr/local/haproxy/conf/option-http_proxy.cfg
  ```

- Проверьте HAProxy.
  
  ```bash
  ps -ef | grep haproxy
  ```
  
  На экране отобразится процесс HAProxy.
  
  Откройте браузер, введите в адресной строке http:*//IP-адрес* *HAProxy*:80 и нажмите **Enter**. Появится страница веб-интерфейса backend-сервера, что означает корректный запуск HAProxy. Обновите страницу. Данная страница переключает между backend-серверами.
  
  Примечание.
  
  - (Опционально) Остановите HAProxy. Не выполняйте данную команду, если какие-либо службы в данный момент работают.
    
    ```bash
    pkill haproxy
    ```
  
  - (Опционально) Удалите HAProxy и запросите результат.
    
    ```bash
    rpm -qa | grep haproxy
    ```
    
    ```bash
    rpm -e --nodeps haproxy-1.9.0
    ```
    
    ```bash
    rpm -qa | grep haproxy
    ```
    
    ```bash
    rm -rf /usr/local/haproxy
    ```